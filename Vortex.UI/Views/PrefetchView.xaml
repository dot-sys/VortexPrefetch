<Page
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:converters="clr-namespace:Vortex.UI.Converters"
  x:Class="Vortex.UI.Views.PrefetchView"
  Title="{DynamicResource FATAnalyzer}"
  Background="Transparent"
  Loaded="Page_Loaded">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:RowForegroundConverter x:Key="RowForegroundConverter"/>
        <ContextMenu x:Key="DataGridContextMenu" x:Shared="False" Opened="DataGridContextMenu_Opened" Style="{StaticResource VortexDataGridContextMenuStyle}">
            <MenuItem x:Name="GoToMenuItem" Header="{DynamicResource GoTo}" Click="ContextMenu_GoTo_Click"/>
            <MenuItem Header="{DynamicResource CopyValue}" Click="ContextMenu_CopyValue_Click"/>
            <MenuItem Header="{DynamicResource CopyRow}" Click="ContextMenu_CopyRow_Click"/>
        </ContextMenu>
    </Page.Resources>

    <Border Background="#000000" CornerRadius="0,0,8,8">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Top Controls: Unmark Toggles -->
            <Border Grid.Row="0"
                Padding="8,6"
                Margin="0,0,0,10">
                <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Center">
                    <Grid Width="200" Margin="0,0,12,0" VerticalAlignment="Center">
                        <TextBox x:Name="SourcePathSearchBox"
                                 Text="{Binding SourcePathSearchText, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="{DynamicResource SearchSourcePath}"/>
                        <TextBlock Text="{DynamicResource SearchSourcePath}"
                                   IsHitTestVisible="False"
                                   Foreground="#666"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Text, ElementName=SourcePathSearchBox}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Text, ElementName=SourcePathSearchBox}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                    <ToggleButton Content="{DynamicResource UnmarkDeleted}" 
                              IsChecked="{Binding MarkDeletedRed, Mode=TwoWay}"
                              Cursor="Hand"
                              Margin="0,0,10,0"/>
                    <ToggleButton Content="{DynamicResource UnmarkUnsigned}" 
                              IsChecked="{Binding MarkUnsignedGold, Mode=TwoWay}"
                              Cursor="Hand"
                              Margin="0,0,12,0"/>
                    <Button Content="{DynamicResource TamperingCheck}"
                            Click="TamperingCheck_Click"
                            Cursor="Hand"
                            Margin="0,0,12,0"
                            Padding="10,4"/>
                    <Grid Width="200" VerticalAlignment="Center">
                        <TextBox x:Name="LeftSearchBox"
                                 Text="{Binding LeftSearchText, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="{DynamicResource SearchFilesLoaded}"/>
                        <TextBlock Text="{DynamicResource SearchFilesLoaded}"
                                   IsHitTestVisible="False"
                                   Foreground="#666"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Text, ElementName=LeftSearchBox}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Text, ElementName=LeftSearchBox}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Main Content: DataGrids -->
            <Grid Grid.Row="1">
                <!-- Files DataGrids -->
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="179"/>
                    </Grid.RowDefinitions>

                    <!-- DataGrid -->
                    <Border Grid.Row="0"
                            BorderBrush="#333333" 
                            BorderThickness="1">
                        <DataGrid x:Name="FilesDataGrid"
                                  Style="{StaticResource VortexDataGridStyle}"
                                   ItemsSource="{Binding FilteredFilesView}"
                                  AutoGenerateColumns="False"
                                  CanUserResizeColumns="True"
                                  SelectionChanged="FilesDataGrid_SelectionChanged"
                                  PreviewMouseRightButtonDown="DataGrid_PreviewMouseRightButtonDown"
                                  ContextMenu="{StaticResource DataGridContextMenu}"
                                  EnableRowVirtualization="True"
                                  EnableColumnVirtualization="True"
                                  VirtualizingStackPanel.IsVirtualizing="True"
                                  VirtualizingStackPanel.VirtualizationMode="Recycling"
                                  ScrollViewer.CanContentScroll="True"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <SolidColorBrush Color="#000000"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="Foreground">
                                        <Setter.Value>
                                            <MultiBinding Converter="{StaticResource RowForegroundConverter}">
                                                <Binding Path="DataContext.MarkDeletedRed" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                <Binding Path="Status"/>
                                                <Binding Path="DataContext.MarkUnsignedGold" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                <Binding Path="SignatureStatus"/>
                                            </MultiBinding>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="AlternationIndex" Value="1">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="#0a0a0a"/>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="#252525"/>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="#1A1A1A"/>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="{DynamicResource SourceName}" Binding="{Binding ExecutableName}" Width="220"/>
                                <DataGridTextColumn Header="{DynamicResource SourcePath}" Binding="{Binding ExecutableFullPath}" Width="445"/>
                                <DataGridTextColumn Header="{DynamicResource RunCount}" Binding="{Binding RunCount}" Width="75"/>
                                <DataGridTextColumn Header="{DynamicResource LastRun}" Binding="{Binding LastRun, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150"/>
                                <DataGridTextColumn Header="{DynamicResource LastRun8}" Binding="{Binding PreviousRun6, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150"/>
                                <DataGridTextColumn Header="{DynamicResource SourceCreatedOn}" Binding="{Binding SourceCreatedOn, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150"/>
                                <DataGridTextColumn Header="{DynamicResource Status}" Binding="{Binding Status}" Width="70"/>
                                <DataGridTextColumn Header="{DynamicResource Signature}" Binding="{Binding SignatureStatus}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>

                    <!-- Bottom DataGrids -->
                    <Grid Grid.Row="1" Margin="0,12,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" BorderBrush="#333333" BorderThickness="1" Margin="0,0,6,0">
                            <DataGrid x:Name="LeftDataGrid"
                                      Style="{StaticResource VortexDataGridStyle}"
                                      ItemsSource="{Binding LeftGridView}"
                                      RowBackground="#000000"
                                      AlternatingRowBackground="#0a0a0a"
                                      AutoGenerateColumns="False"
                                      CanUserResizeColumns="True"
                                      CanUserSortColumns="False"
                                      IsReadOnly="True"
                                      PreviewMouseRightButtonDown="DataGrid_PreviewMouseRightButtonDown"
                                      ContextMenu="{StaticResource DataGridContextMenu}"
                                      EnableRowVirtualization="True"
                                      EnableColumnVirtualization="True"
                                      VirtualizingStackPanel.IsVirtualizing="True"
                                      VirtualizingStackPanel.VirtualizationMode="Recycling"
                                      ScrollViewer.CanContentScroll="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="" Binding="{Binding Index}" Width="30"/>
                                    <DataGridTextColumn Header="{DynamicResource FilesLoaded}" Binding="{Binding Directory}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Border>
                        <Border Grid.Column="1" BorderBrush="#333333" BorderThickness="1" Margin="6,0,0,0">
                            <DataGrid x:Name="RightDataGrid"
                                      Style="{StaticResource VortexDataGridStyle}"
                                      ItemsSource="{Binding RightGridData}"
                                      RowBackground="#000000"
                                      AlternatingRowBackground="#0a0a0a"
                                      AutoGenerateColumns="False"
                                      CanUserResizeColumns="True"
                                      CanUserSortColumns="False"
                                      IsReadOnly="True"
                                      PreviewMouseRightButtonDown="DataGrid_PreviewMouseRightButtonDown"
                                      ContextMenu="{StaticResource DataGridContextMenu}"
                                      EnableRowVirtualization="True"
                                      EnableColumnVirtualization="True"
                                      VirtualizingStackPanel.IsVirtualizing="True"
                                      VirtualizingStackPanel.VirtualizationMode="Recycling"
                                      ScrollViewer.CanContentScroll="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="{DynamicResource Info}" Binding="{Binding Info}" Width="150"/>
                                    <DataGridTemplateColumn Header="{DynamicResource Value}" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Value}"/>
                                                    <TextBlock Text=" " />
                                                    <TextBlock x:Name="VirusLinkBlock" Visibility="Collapsed">
                                                        <Hyperlink NavigateUri="{Binding Value, StringFormat=https://www.virustotal.com/gui/file/{0}}"
                                                                  RequestNavigate="VirusTotalLink_RequestNavigate"
                                                                  TextDecorations="None"
                                                                  Foreground="#6495ed"
                                                                  Cursor="Hand">
                                                            <Run Text="(VirusTotal)" />
                                                        </Hyperlink>
                                                    </TextBlock>
                                                </StackPanel>
                                                <DataTemplate.Triggers>
                                                    <DataTrigger Binding="{Binding Info}" Value="MD5 Hash">
                                                        <Setter TargetName="VirusLinkBlock" Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Value}" Value="">
                                                        <Setter TargetName="VirusLinkBlock" Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Value}" Value="N/A">
                                                        <Setter TargetName="VirusLinkBlock" Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </DataTemplate.Triggers>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Border>
                    </Grid>
                </Grid>
            </Grid>

            <!-- Loading Overlay -->
            <Grid Grid.RowSpan="2" 
                                                                  Background="#CC000000" 
                                                                  Visibility="{Binding IsLoadingOverlayVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                  IsHitTestVisible="{Binding IsLoadingOverlayVisible}">
                <StackPanel HorizontalAlignment="Center" 
                                                                            VerticalAlignment="Center">
                    <TextBlock Text="{Binding LoadingMessage}" 
                                                                               Foreground="White"
                                                                               FontSize="14"
                                                                               FontFamily="Consolas"
                                                                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</Page>
